#!/usr/bin/env bash

set -eou pipefail

OLD_PASSWORD='raspberry'
NEW_PASSWORD=null
PATH_TO_SSH_KEY='/home/pi/.ssh/id_ed25519'
HOSTNAME=null
ENABLE_SPI=false

usage(){
    echo "Usage: $(basename "${0}") -n <NEW_PASSWORD> -h <HOSTNAME> [-o <OLD_PASSWORD>] [-i <PATH_TO_SSH_KEY>] [-s]"
    echo "Run this from the raspberry pi."
    echo "  -n NEW_PASSWORD    : Set the new password. Required."
    echo "  -h HOSTNAME        : Set the hostname. Required."
    echo "  -o OLD_PASSWORD    : defaults to: $OLD_PASSWORD"
    echo "  -i PATH_TO_SSH_KEY : defaults to: $PATH_TO_SSH_KEY"
    echo "  -s                 : Enable SPI"
    exit 1
}

while getopts ":n:h:o:i:s" opt; do
    case ${opt} in
        n)
            if [ -z "$OPTARG" ]; then
                echo "The -n arg is required."
                usage
            fi
            NEW_PASSWORD=${OPTARG}
            ;;
        h)
            if [[ "$OPTARG" =~ ^[a-z]([a-z0-9-]*[a-z0-9])?$ ]]; then
                HOSTNAME=${OPTARG}
            else
                echo "Invalid hostname."
                usage
            fi
            ;;
        o) OLD_PASSWORD=${OPTARG} ;;
        i) PATH_TO_SSH_KEY=${OPTARG} ;;
        s) ENABLE_SPI=true ;;
        *) usage ;;
      esac
done

main(){
    validateOpts

    setupSshKey
    updateAndInstallPackages
    setupGit
    installRmate
    changeAndSetupShell
    setHostname
    maybeEnableSpi
    changePassword

    echo -e "\\nRestarting..."
    echo "Pi will be available via:"
    echo -e "  ssh pi@$HOSTNAME.local\\n"
    sudo shutdown -r now
}

validateOpts(){
    if [[ ${NEW_PASSWORD} == "null" || ${HOSTNAME} == "null" ]]; then
        echo "Must set -n and / or -h options."
        usage
    fi
}

setupSshKey(){
    echo -e "\\nSetting up ssh key... If you still need to add this key to your github account, see: "
    echo "https://docs.github.com/en/github/authenticating-to-github/adding-a-new-ssh-key-to-your-github-account"
    echo "https://github.com/settings/keys"
    eval "$(ssh-agent -s)"
    ssh-add "$PATH_TO_SSH_KEY"
}

updateAndInstallPackages(){
    echo -e "\\nUpdating and installing packages..."
    sudo apt-get update
    sudo apt-get -y install fzf git locate vim zsh zsh-syntax-highlighting
    sudo apt-get -y dist-upgrade
}

# use diff-highlight as diff tool / pager
setupGit(){
    make -C /usr/share/doc/git/contrib/diff-highlight
    git config --global core.pager '/usr/share/doc/git/contrib/diff-highlight/diff-highlight | less'
}

# allows `subl path_to_file.txt` to use sublime text to edit the file on the pi
# By default we are using a non-standard port so that we don't conflict with a friend who may
# be hacking on the same device at the same time also using rmate. We use 52699 instead of the
# standard 52699.
#
# This requires:
# 1) aliasing the `subl` command in ~/.zshrc to use our port
# 2) setting up ssh port forwarding for our port in the computer we are sshing from
# 3) configuring the rsub sublime plugin to use our port in its settings (package control -> list packages -> rsub)
installRmate(){
    sudo wget -O /usr/local/bin/subl https://raw.githubusercontent.com/aurora/rmate/master/rmate
    sudo chmod a+x /usr/local/bin/subl
}

changeAndSetupShell(){
    # change default shell
    echo "$OLD_PASSWORD" | chsh -s /usr/bin/zsh

    # oh-my-zsh
    sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"

    # iterm shell integration
    curl -L https://iterm2.com/shell_integration/zsh -o ~/.iterm2_shell_integration.zsh

    # change native zsh autocomplete to always use fzf
    # https://github.com/Aloxaf/fzf-tab#install
    fzf_tab_dir="$HOME/.config/zsh"
    mkdir -p "$fzf_tab_dir"
    git -C "$fzf_tab_dir" clone https://github.com/Aloxaf/fzf-tab
}

# Allows sshing and hitting the pifi webpage via "<hostname>.local"
# See: https://www.raspberrypi.org/documentation/remote-access/ip-address.md "Resolving raspberrypi.local with mDNS"
setHostname(){
    echo -e "\\nSetting hostname to: $HOSTNAME"
    if [[ $(cat /etc/hostname) != pifi ]]; then
        echo "$HOSTNAME" | sudo tee /etc/hostname >/dev/null 2>&1
        sudo sed -i -E 's/(127\.0\.1\.1\s+)[^ ]+/\1'"$HOSTNAME"'/g' /etc/hosts
    fi
}

maybeEnableSpi(){
    if [[ ${ENABLE_SPI} == "true" ]]; then
        echo -e "\\nEnabling SPI..."
        # https://raspberrypi.stackexchange.com/a/96679
        sudo raspi-config nonint do_spi 0
    fi
}

changePassword(){
    echo -e "\\nChanging password to: $NEW_PASSWORD"
    echo -e "$OLD_PASSWORD\n$NEW_PASSWORD\n$NEW_PASSWORD" | passwd
}

main
